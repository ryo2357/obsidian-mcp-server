# 003-test-script

作成日時: 2025-07-30 02:30

## 概要

テストスクリプトの役割明確化、実装の説明。テストスクリプトの目的・機能の整理と、テスト用同期モード（--sync）の実装意図について。

## テストスクリプトの目的と機能

### テストスクリプトの目的

1. **MCP サーバーの動作確認**

   - Rust プログラム変更後の回帰テスト
   - MCP プロトコルの正常動作確認
   - JSON-RPC 2.0 通信の入出力テスト

2. **開発効率の向上**

   - 手動テスト作業の自動化
   - 一貫したテスト環境の提供
   - エラー発生時の迅速な問題特定

3. **品質保証**
   - 基本機能の動作保証
   - プロトコル準拠性の確認
   - 環境依存問題の早期発見

### テストスクリプトの機能

#### PowerShell 版（test_mcp.ps1）

- JSON データをスクリプト内で直接定義
- Test-MCPCommand 関数による自動テスト実行
- カラー出力による結果表示（成功/失敗の視覚化）
- エラーハンドリング機能付き

#### Bash 版（test_mcp.sh）

- UNIX/Linux 環境での同等機能提供
- 変数による JSON データ管理
- test_mcp_command 関数による自動実行
- 成功/失敗の判定機能

### テスト対象機能

1. **Initialize Protocol**: MCP サーバーの初期化
2. **List Available Tools**: 利用可能ツールの一覧取得
3. **Execute Ping Tool**: 基本的なツール実行テスト

## 同期モード（--sync）の実装意図

### 実装背景

MCP サーバーは本来、非同期（tokio）で動作するが、テスト環境では以下の問題が発生：

1. **PowerShell パイプとの非互換性**: 非同期 I/O とパイプ処理の相性問題
2. **デバッグの困難さ**: 非同期処理によるエラー原因特定の複雑化
3. **テスト結果の不安定性**: 実行順序の不確定性

### 同期モードの技術仕様

#### clap 引数定義

```rust
.arg(
    Arg::new("sync")
        .long("sync")
        .action(clap::ArgAction::SetTrue)
        .help("Run in synchronous mode (for testing)"),
)
```

#### 動作モードの選択

```rust
if matches.get_flag("sync") {
    info!("Running in synchronous mode");
    server.run_sync()?;          // 同期モード
} else {
    server.run().await?;         // 非同期モード（デフォルト）
}
```

### 同期モード vs 非同期モードの特徴比較

#### 非同期モード（本番用）

- **I/O**: tokio 非同期ランタイム使用
- **性能**: 高性能、多数の同時接続対応
- **用途**: 本番環境に適している
- **デバッグ**: 複雑（非同期処理のため）

#### 同期モード（テスト用）

- **I/O**: 標準ライブラリの同期 I/O 使用
- **性能**: 劣る（順次処理）
- **用途**: テスト・開発環境に適している
- **デバッグ**: 簡単（順次実行）

### テスト実行における利点

#### PowerShell パイプとの相性

```powershell
$JsonCommand | cargo run -- --sync --vault ./test-vault 2>&1
```

1. **確実な通信**: 標準 I/O による安定したデータ送受信
2. **順次処理**: テストケースの確実な順番実行
3. **出力捕捉**: 標準出力/エラー出力の確実な取得
4. **レスポンス時間**: 一貫した応答時間

#### デバッグ効率の向上

- **エラー再現**: 問題の一貫した再現が可能
- **ログ順序**: ログ出力の順序保証
- **ステップ実行**: 処理の段階的確認が容易
